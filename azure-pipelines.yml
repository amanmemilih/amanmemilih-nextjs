trigger:
  branches:
    exclude:
    - "*"

  tags:
    include:
    - v*

variables:
- group: ARGOCD_VARIABLES
- name: imageName
  value: 211104/amanmemilih-frontend
- name: tag
  value: $(Build.SourceBranchName)
- name: argocdAppName
  value: amanmemilih-frontend

resources:
  repositories:
  - repository: HelmChartRepository
    type: github
    endpoint: https://github.com/yazidalg/motion-chart
    name: MotionChart
    ref: main

pool:
  vmImage: ubuntu-latest

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: BuildAndPush
    steps:
    - task: Docker@2
      displayName: Build and Push Docker Image
      inputs:
        containerRegistry: yazids-docker
        repository: $(imageName)
        command: buildAndPush
        Dockerfile: Dockerfile
        tags: |
          $(tag)

- stage: UpdateHelmChart
  dependsOn: BuildAndPush
  displayName: Update Helm Chart (GitOps)
  jobs:
  - job: UpdateHelmChart

    steps:
    - checkout: HelmChartRepository

    - script: |
        set -euo pipefail
        mkdir -p "$HOME/.local/bin"
        wget -qO "$HOME/.local/bin/yq" https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        chmod +x "$HOME/.local/bin/yq"
      displayName: Install yq (no sudo)
    
    - script: |
        set -euo pipefail
        FILE="motion-chart/amanmemilih-frontend/values.yaml"
        TAG="$(Build.SourceBranchName)"
        yq -i ".image.tag = \"${TAG}\"" "$FILE"
      displayName: Update Image Tag

    - script: |
        set -euo pipefail
        cd motion-chart
        git config user.name "ci-bot"
        git config user.email "ci-bot@users.noreply.github.com"
        git add amanmemilih-frontend/values.yaml
        git commit -m "chore(amanmemilih-frontend): bump image tag to $(Build.SourceBranchName)"
        git push
      displayName: Commit and push to Helm repo
